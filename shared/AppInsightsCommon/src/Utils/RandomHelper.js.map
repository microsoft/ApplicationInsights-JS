{"version":3,"file":"RandomHelper.js","sourceRoot":"","sources":["RandomHelper.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved.\r\n// Licensed under the MIT License.\r\nimport { mathFloor, utcNow } from \"@nevware21/ts-utils\";\r\nimport { STR_EMPTY } from \"../InternalConstants\";\r\nimport { getCrypto, getMsCrypto, isIE } from \"./EnvUtils\";\r\n\r\nconst UInt32Mask = 0x100000000;\r\nconst MaxUInt32 = 0xffffffff;\r\nconst SEED1 = 123456789\r\nconst SEED2 = 987654321\r\n\r\n// MWC based Random generator (for IE)\r\nlet _mwcSeeded = false;\r\nlet _mwcW = SEED1;\r\nlet _mwcZ = SEED2;\r\n\r\n// Takes any integer\r\nfunction _mwcSeed(seedValue: number) {\r\n    if (seedValue < 0) {\r\n        // Make sure we end up with a positive number and not -ve one.\r\n        seedValue >>>= 0;\r\n    }\r\n\r\n    _mwcW = (SEED1 + seedValue) & MaxUInt32;\r\n    _mwcZ = (SEED2 - seedValue) & MaxUInt32;\r\n    _mwcSeeded = true;\r\n}\r\n\r\nfunction _autoSeedMwc() {\r\n    // Simple initialization using default Math.random() - So we inherit any entropy from the browser\r\n    // and bitwise XOR with the current milliseconds\r\n    try {\r\n        const now = utcNow() & 0x7fffffff;\r\n        _mwcSeed(((Math.random() * UInt32Mask) ^ now) + now);\r\n    } catch (e) {\r\n        // Don't crash if something goes wrong\r\n    }\r\n}\r\n\r\n/**\r\n * Generate a random value between 0 and maxValue, max value should be limited to a 32-bit maximum.\r\n * So maxValue(16) will produce a number from 0..16 (range of 17)\r\n * @param maxValue - The max value for the range\r\n */\r\nexport function randomValue(maxValue: number) {\r\n    if (maxValue > 0) {\r\n        return mathFloor((random32() / MaxUInt32) * (maxValue + 1)) >>> 0;\r\n    }\r\n\r\n    return 0;\r\n}\r\n\r\n/**\r\n * generate a random 32-bit number (0x000000..0xFFFFFFFF) or (-0x80000000..0x7FFFFFFF), defaults un-unsigned.\r\n * @param signed - True to return a signed 32-bit number (-0x80000000..0x7FFFFFFF) otherwise an unsigned one (0x000000..0xFFFFFFFF)\r\n */\r\nexport function random32(signed?: boolean) {\r\n    let value = 0;\r\n    let c = getCrypto() || getMsCrypto();\r\n    if (c && c.getRandomValues) {\r\n        // Make sure the number is converted into the specified range (-0x80000000..0x7FFFFFFF)\r\n        value = c.getRandomValues(new Uint32Array(1))[0] & MaxUInt32;\r\n    }\r\n    \r\n    if (value === 0 && isIE()) {\r\n        // For IE 6, 7, 8 (especially on XP) Math.random is not very random\r\n        if (!_mwcSeeded) {\r\n            // Set the seed for the Mwc algorithm\r\n            _autoSeedMwc();\r\n        }\r\n\r\n        // Don't use Math.random for IE\r\n        // Make sure the number is converted into the specified range (-0x80000000..0x7FFFFFFF)\r\n        value = mwcRandom32() & MaxUInt32;\r\n    }\r\n\r\n    if (value === 0) {\r\n        // Make sure the number is converted into the specified range (-0x80000000..0x7FFFFFFF)\r\n        value = mathFloor((UInt32Mask * Math.random()) | 0);\r\n    }\r\n\r\n    if (!signed) {\r\n        // Make sure we end up with a positive number and not -ve one.\r\n        value >>>= 0;\r\n    }\r\n\r\n    return value;\r\n}\r\n\r\n/**\r\n * Seed the MWC random number generator with the specified seed or a random value\r\n * @param value - optional the number to used as the seed, if undefined, null or zero a random value will be chosen\r\n */\r\nexport function mwcRandomSeed(value?: number) {\r\n    if (!value) {\r\n        _autoSeedMwc();\r\n    } else {\r\n        _mwcSeed(value);\r\n    }\r\n}\r\n\r\n/**\r\n * Generate a random 32-bit number between (0x000000..0xFFFFFFFF) or (-0x80000000..0x7FFFFFFF), using MWC (Multiply with carry)\r\n * instead of Math.random() defaults to un-signed.\r\n * Used as a replacement random generator for IE to avoid issues with older IE instances.\r\n * @param signed - True to return a signed 32-bit number (-0x80000000..0x7FFFFFFF) otherwise an unsigned one (0x000000..0xFFFFFFFF)\r\n */\r\nexport function mwcRandom32(signed?: boolean) {\r\n    _mwcZ = (36969 * (_mwcZ & 0xFFFF) + (_mwcZ >> 16)) & MaxUInt32;\r\n    _mwcW = (18000 * (_mwcW & 0xFFFF) + (_mwcW >> 16)) & MaxUInt32;\r\n\r\n    let value = (((_mwcZ << 16) + (_mwcW & 0xFFFF)) >>> 0) & MaxUInt32 | 0;\r\n\r\n    if (!signed) {\r\n        // Make sure we end up with a positive number and not -ve one.\r\n        value >>>= 0;\r\n    }\r\n\r\n    return value;\r\n}\r\n\r\n/**\r\n * Generate random base64 id string.\r\n * The default length is 22 which is 132-bits so almost the same as a GUID but as base64 (the previous default was 5)\r\n * @param maxLength - Optional value to specify the length of the id to be generated, defaults to 22\r\n */\r\nexport function newId(maxLength = 22): string {\r\n    const base64chars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";\r\n\r\n    // Start with an initial random number, consuming the value in reverse byte order\r\n    let number = random32() >>> 0;  // Make sure it's a +ve number\r\n    let chars = 0;\r\n    let result = STR_EMPTY;\r\n    while (result.length < maxLength) {\r\n        chars ++;\r\n        result += base64chars.charAt(number & 0x3F);\r\n        number >>>= 6;              // Zero fill with right shift\r\n        if (chars === 5) {\r\n            // 5 base64 characters === 30 bits so we don't have enough bits for another base64 char\r\n            // So add on another 30 bits and make sure it's +ve\r\n            number = (((random32() << 2) & 0xFFFFFFFF) | (number & 0x03)) >>> 0;\r\n            chars = 0;      // We need to reset the number every 5 chars (30 bits)\r\n        }\r\n    }\r\n\r\n    return result;\r\n}\r\n"]}